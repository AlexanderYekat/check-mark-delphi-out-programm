Процедура КнопкаПроверитьМаркуНаККТАсинхНажатие(Элемент)
	УровеньОтладки = ПечатьЧекаККТКлиент.ПолучитьЗначениеНастройки(структураНастройкаиСвязиСКТТ, "УровеньОтладки");
	Если УровеньОтладки >=3 тогда
		Сообщить("СканируемНажатие");
	конецЕсли;	
	СериияДляМаркиТестЧисло = 930;
	СериияДляМаркиТестСтрка = Формат(СериияДляМаркиТестЧисло, "ЧГ=");
	Если СтрДлина(СокрЛП(Элемент)) = 3 тогда
		СериияДляМаркиТестСтрка = СокрЛП(Элемент);
	конецЕсли;             	                    
	марка = "01047510084300422152yWbQ" + Символ(29) + СериияДляМаркиТестСтрка+ "Hw+";
	марка = СтрЗаменить(марка, Символ(29), "\u001d");
	//ВнешнееСобытие("BarCodeScaner", "BarCodeValue", "01047510084300422152yWbQ" + Символ(29) + СериияДляМаркиТестСтрка+ "Hw+");
	
	// Формируем массив марок для проверки
	МассивМарок = Новый Массив;
	МассивМарок.Добавить(марка);
	
	ТекущийИдентификаторЗадачи = ПечатьЧекаККТАсинх.ПроверитьМаркуНаККТ(МассивМарок);
	МаксимальноеКоличествоПопыток = 10;
	ТекущаяПопытка = 0;
	
    // Подключаем обработчик ожидания (вызов каждые 2 секунды)
    ПодключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки", 2);
КонецПроцедуры     

Процедура ПроверитьСтатусЗадачиМаркировки() Экспорт
    
    Если ПустаяСтрока(ТекущийИдентификаторЗадачи) Тогда
        Возврат;
    КонецЕсли;
    
	Сообщить("ПроверитьСтатусЗадачиМаркировки");
	Сообщить("ТекущийИдентификаторЗадачи: " + ТекущийИдентификаторЗадачи);
	Сообщить("МаксимальноеКоличествоПопыток: " + МаксимальноеКоличествоПопыток);
	Сообщить("ТекущаяПопытка: " + ТекущаяПопытка);
    
    // Проверяем статус задачи через файловую систему
    Попытка
        // Проверяем файл с результатом в папке completed
        ПутьКФайлуCompleted = "c:\share\tasks\completed\" + ТекущийИдентификаторЗадачи + ".json";
        ФайлCompleted = Новый Файл(ПутьКФайлуCompleted);
        
        Если ФайлCompleted.Существует() Тогда
            // Результат готов - читаем файл
            ЧтениеТекста = Новый ЧтениеТекста(ПутьКФайлуCompleted, КодировкаТекста.UTF8);
            ТелоОтвета = ЧтениеТекста.Прочитать();
            ЧтениеТекста.Закрыть();
            
            // Парсим JSON
            ЧтениеJSON = Новый ЧтениеJSON;
            ЧтениеJSON.УстановитьСтроку(ТелоОтвета);
            ОтветСтатус = ПрочитатьJSON(ЧтениеJSON);
            ЧтениеJSON.Закрыть();
            
        Иначе
            // Проверяем, в обработке ли задание
            ПутьКФайлуProcessing = "c:\share\tasks\processing\" + ТекущийИдентификаторЗадачи + ".json";
            ФайлProcessing = Новый Файл(ПутьКФайлуProcessing);
            
            Если ФайлProcessing.Существует() Тогда
                // Задание в обработке - формируем ответ "processing"
                ОтветСтатус = Новый Структура;
                ОтветСтатус.Вставить("success", Истина);
                СтруктураData = Новый Структура;
                СтруктураData.Вставить("status", "processing");
                ОтветСтатус.Вставить("data", СтруктураData);
            Иначе
                // Задание еще в pending - формируем ответ "pending"
                ОтветСтатус = Новый Структура;
                ОтветСтатус.Вставить("success", Истина);
                СтруктураData = Новый Структура;
                СтруктураData.Вставить("status", "pending");
                ОтветСтатус.Вставить("data", СтруктураData);
            КонецЕсли;
        КонецЕсли;
        
    Исключение
        ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
        Сообщить("Ошибка чтения файла: " + ОписаниеОшибки());
        ТекущийИдентификаторЗадачи = "";
        Возврат;
    КонецПопытки;
    
    // Проверяем ответ
    Если Не ОтветСтатус.Свойство("success") ИЛИ Не ОтветСтатус.success Тогда
        ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
        Сообщить("Ошибка получения статуса");
        ТекущийИдентификаторЗадачи = "";
        Возврат;
    КонецЕсли;
    
    Если Не ОтветСтатус.Свойство("data") Тогда
        ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
        Сообщить("Неверный формат ответа");
        ТекущийИдентификаторЗадачи = "";
        Возврат;
    КонецЕсли;
    
    Статус = ОтветСтатус.data.status;
    
    // Обрабатываем статус
    Если Статус = "completed" Тогда
        // Задача завершена
        ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
        
        Если ОтветСтатус.data.Свойство("result") Тогда
            Результат = ОтветСтатус.data.result;
            
			//// Вызываем обработчик, если указан
			//Если Не ПустаяСтрока(ОбработчикЗавершения) Тогда
			//    Выполнить(ОбработчикЗавершения + "(Истина, Результат, """")");
			//Иначе
                // Стандартная обработка
                Сообщить("✓ Проверка завершена!");
                Если Результат.Свойство("success") И Результат.success Тогда
                    Сообщить("Марка прошла проверку на ККТ");
                Иначе
                    Сообщить("Марка НЕ прошла проверку на ККТ");
                КонецЕсли;
			//КонецЕсли;
        КонецЕсли;
        
        ТекущийИдентификаторЗадачи = "";
        
    ИначеЕсли Статус = "error" Тогда
        // Ошибка
        ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
        
        ТекстОшибки = "Ошибка проверки";
        Если ОтветСтатус.data.Свойство("error") Тогда
            ТекстОшибки = ОтветСтатус.data.error;
        КонецЕсли;
        
		//Если Не ПустаяСтрока(ОбработчикЗавершения) Тогда
		//    Выполнить(ОбработчикЗавершения + "(Ложь, Неопределено, """ + ТекстОшибки + """)");
		//Иначе
            Сообщить("✗ " + ТекстОшибки);
		//КонецЕсли;
        
        ТекущийИдентификаторЗадачи = "";
        
    Иначе
        // pending или processing - продолжаем ждать
        ТекущаяПопытка = ТекущаяПопытка + 1;
        
        Если ТекущаяПопытка >= МаксимальноеКоличествоПопыток Тогда
            // Таймаут
            ОтключитьОбработчикОжидания("ПроверитьСтатусЗадачиМаркировки");
            
            ТекстОшибки = "Превышено время ожидания (" + Формат(МаксимальноеКоличествоПопыток * 2, "ЧГ=") + " сек)";
            
			//Если Не ПустаяСтрока(ОбработчикЗавершения) Тогда
			//    Выполнить(ОбработчикЗавершения + "(Ложь, Неопределено, """ + ТекстОшибки + """)");
			//Иначе
                Сообщить("⏱ " + ТекстОшибки);
			//КонецЕсли;
            
            ТекущийИдентификаторЗадачи = "";
        КонецЕсли;
        
    КонецЕсли;
    
КонецПроцедуры
