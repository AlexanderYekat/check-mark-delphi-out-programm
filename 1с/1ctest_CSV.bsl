// =====================================================
// ТЕСТОВЫЙ МОДУЛЬ: Интеграция с Delphi через CSV
// =====================================================

Процедура КнопкаПроверитьМаркуНаККТНажатие(Элемент)
    
    СериияДляМаркиТестЧисло = 930;
    СериияДляМаркиТестСтрка = Формат(СериияДляМаркиТестЧисло, "ЧГ=");
    
    Если СтрДлина(СокрЛП(Элемент)) = 3 Тогда
        СериияДляМаркиТестСтрка = СокрЛП(Элемент);
    КонецЕсли;
    
    // Формируем тестовую марку
    марка = "01047510084300422152yWbQ" + Символ(29) + СериияДляМаркиТестСтрка + "Hw+";
    
    Сообщить("=== ПРОВЕРКА МАРКИ ЧЕРЕЗ CSV ===");
    Сообщить("Марка: " + марка);
    Сообщить("");
    
    // Формируем массив марок
    МассивМарок = Новый Массив;
    
    Марка1 = Новый Структура;
    Марка1.Вставить("Позиция", 1);
    Марка1.Вставить("КодМаркировки", марка);
    Марка1.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка1);
    
    // Параметры чека
    ПараметрыЧека = Новый Структура;
    ПараметрыЧека.Вставить("ТипЧека", "sell");
    ПараметрыЧека.Вставить("ИмяКассира", "Тестовый кассир");
    ПараметрыЧека.Вставить("ТаймЗона", 6);
    
    // Записываем CSV файлы
    Если ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Тогда
        Сообщить("✓ CSV файлы готовы");
        Сообщить("");
        Сообщить(">>> СЛЕДУЮЩИЙ ШАГ <<<");
        Сообщить("1. Откройте Delphi программу");
        Сообщить("2. Нажмите кнопку 'Загрузить данные' (CreateNewSession)");
        Сообщить("3. Программа проверит марки на ККТ");
        Сообщить("4. Нажмите 'Сохранить результаты' (FinishSession)");
        Сообщить("5. Вернитесь в 1С и вызовите: ПроверитьСтатусПроверкиМарки()");
    Иначе
        Сообщить("✗ Ошибка записи CSV файлов");
    КонецЕсли;
    
КонецПроцедуры


Процедура ПроверитьСтатусПроверкиМарки() Экспорт
    
    Сообщить("=== ПРОВЕРКА СТАТУСА ПРОВЕРКИ ===");
    Сообщить("");
    
    // Проверяем, готов ли файл результатов
    ПутьКФайлу = "c:\share\output_results.csv";
    Файл = Новый Файл(ПутьКФайлу);
    
    Если Не Файл.Существует() Тогда
        Сообщить("⏱ Результаты еще не готовы");
        Сообщить("Delphi программа еще обрабатывает марки");
        Сообщить("Подождите и повторите проверку");
        Возврат;
    КонецЕсли;
    
    // Читаем результаты
    Результаты = ПрочитатьРезультатыПроверки();
    
    Если Результаты.Количество() = 0 Тогда
        Сообщить("⚠ Файл результатов пуст");
        Возврат;
    КонецЕсли;
    
    // Обрабатываем результаты
    Для Каждого Рез Из Результаты Цикл
        Сообщить("--- РЕЗУЛЬТАТ ПРОВЕРКИ ---");
        Сообщить("Позиция: " + Формат(Рез.Позиция, "ЧГ=0"));
        Сообщить("Код результата: " + Формат(Рез.КодПроверкиККТ, "ЧГ=0"));
        Сообщить("Описание: " + Рез.ОписаниеРезультатаККТ);
        
        Если Рез.КодПроверкиККТ = 0 И Рез.imcCheckResult Тогда
            Сообщить("✓ Марка прошла проверку на ККТ");
            Сообщить("✓ Марка валидна");
            
            Если Рез.imcEstimatedStatusCorrect Тогда
                Сообщить("✓ Планируемый статус корректен");
            КонецЕсли;
        Иначе
            Сообщить("✗ Марка НЕ прошла проверку на ККТ");
            Сообщить("✗ Марка невалидна или есть ошибки");
        КонецЕсли;
        
        Сообщить("-------------------------");
    КонецЦикла;
    
    // Очищаем CSV файлы после обработки
    Сообщить("");
    Сообщить("Очистка CSV файлов...");
    ОчиститьCSVФайлы();
    Сообщить("✓ Готово");
    
КонецПроцедуры


// =====================================================
// АВТОМАТИЧЕСКАЯ ПРОВЕРКА С ОЖИДАНИЕМ
// =====================================================
// Запускает проверку марки и ждет результат
//
Процедура АвтоматическаяПроверкаМаркиСОжиданием(КодМаркировки, ИмяКассира = "Кассир") Экспорт
    
    МаксимумПопыток = 30; // 30 попыток * 2 секунды = 60 секунд
    ТекущаяПопытка = 0;
    
    Сообщить("=== АВТОМАТИЧЕСКАЯ ПРОВЕРКА МАРКИ ===");
    Сообщить("Марка: " + КодМаркировки);
    Сообщить("");
    
    // Подготовка данных
    МассивМарок = Новый Массив;
    
    Марка = Новый Структура;
    Марка.Вставить("Позиция", 1);
    Марка.Вставить("КодМаркировки", КодМаркировки);
    Марка.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка);
    
    ПараметрыЧека = Новый Структура;
    ПараметрыЧека.Вставить("ТипЧека", "sell");
    ПараметрыЧека.Вставить("ИмяКассира", ИмяКассира);
    ПараметрыЧека.Вставить("ТаймЗона", 6);
    
    // Записываем CSV
    Если НЕ ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Тогда
        Сообщить("✗ Ошибка записи CSV");
        Возврат;
    КонецЕсли;
    
    Сообщить("CSV файлы записаны, ожидание результата...");
    Сообщить("");
    
    // ВАЖНО: Delphi программа должна быть запущена и обрабатывать файлы!
    
    // Ожидание результата
    Пока ТекущаяПопытка < МаксимумПопыток Цикл
        
        // Проверяем наличие файла результатов
        ПутьКФайлу = "c:\share\output_results.csv";
        Файл = Новый Файл(ПутьКФайлу);
        
        Если Файл.Существует() Тогда
            // Результат готов!
            Сообщить("✓ Результат получен");
            
            Результаты = ПрочитатьРезультатыПроверки();
            
            Если Результаты.Количество() > 0 Тогда
                Рез = Результаты[0];
                
                Сообщить("--- РЕЗУЛЬТАТ ---");
                Если Рез.КодПроверкиККТ = 0 И Рез.imcCheckResult Тогда
                    Сообщить("✓ Марка ВАЛИДНА");
                Иначе
                    Сообщить("✗ Марка НЕВАЛИДНА");
                    Сообщить("Код: " + Формат(Рез.КодПроверкиККТ, "ЧГ=0"));
                    Сообщить("Описание: " + Рез.ОписаниеРезультатаККТ);
                КонецЕсли;
                
                // Очистка
                ОчиститьCSVФайлы();
            КонецЕсли;
            
            Возврат;
        КонецЕсли;
        
        // Ждем 2 секунды
        ТекущаяПопытка = ТекущаяПопытка + 1;
        Сообщить("Попытка " + Формат(ТекущаяПопытка, "ЧГ=0") + "/" + Формат(МаксимумПопыток, "ЧГ=0") + "...");
        
        // В реальности здесь должна быть пауза 2 секунды
        // Но в 1С это делается через обработчик ожидания
        
    КонецЦикла;
    
    Сообщить("⏱ Превышено время ожидания");
    Сообщить("Проверьте, запущена ли Delphi программа");
    
КонецПроцедуры


// =====================================================
// ИНСТРУКЦИЯ
// =====================================================
//
// ДЛЯ РУЧНОЙ ПРОВЕРКИ:
// --------------------
// 1. КнопкаПроверитьМаркуНаККТНажатие("930")
// 2. Запустите Delphi, нажмите "Загрузить данные" и "Сохранить результаты"
// 3. ПроверитьСтатусПроверкиМарки()
//
// ДЛЯ АВТОМАТИЧЕСКОЙ ПРОВЕРКИ:
// -----------------------------
// АвтоматическаяПроверкаМаркиСОжиданием("014494550435306821...", "Иванов И.И.")
// (Требуется, чтобы Delphi программа работала в фоне)
//

