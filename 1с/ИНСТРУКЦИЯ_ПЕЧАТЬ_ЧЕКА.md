# Инструкция по использованию функции печати чека через Delphi программу

## Обзор

Добавлена возможность печатать чеки через Delphi программу, используя файловый обмен данными. 1С формирует JSON чека и передает его в программу, программа выполняет печать на ККТ через драйвер АТОЛ и возвращает результат обратно в 1С.

## Схема работы

```
1С → receipt_request.json → Delphi программа → ККТ
1С ← receipt_response.json ← Delphi программа ← ККТ
```

## Файлы для обмена данными

1. **Файл команды** (триггер для запуска обработки):
   ```
   c:\share\checkmarks\commands\print_receipt.cmd
   ```
   - Создается 1С для запуска печати чека
   - Удаляется Delphi программой после получения команды

2. **Файл запроса** (JSON чека от 1С):
   ```
   c:\share\checkmarks\receipt_request.json
   ```
   - Содержит готовый JSON чека, сформированный функцией СформироватьJSONЧека()
   - Удаляется Delphi программой после обработки

3. **Файл ответа** (результат печати):
   ```
   c:\share\checkmarks\receipt_response.json
   ```
   - Содержит результат выполнения команды
   - Формат:
     ```json
     {
       "ответJSON": "JSON ответ от драйвера ККТ",
       "кодОшибки": 0,
       "описаниеОшибки": "OK"
     }
     ```

## Использование в 1С

### Функция для замены ВыполнитьЗаданиеJSON

```bsl
Функция ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки)
	
	ПутьКФайлуЗапроса = "c:\share\checkmarks\receipt_request.json";
	ПутьКФайлуОтвета = "c:\share\checkmarks\receipt_response.json";
	ПутьККомандам = "c:\share\checkmarks\commands\";
	ФайлКомандыПечати = ПутьККомандам + "print_receipt.cmd";
	Таймаут = 60; // Таймаут в секундах
	
	Попытка
		// 1. Удаляем старый файл ответа
		Файл = Новый Файл(ПутьКФайлуОтвета);
		Если Файл.Существует() Тогда
			УдалитьФайлы(ПутьКФайлуОтвета);
		КонецЕсли;
		
		// 2. Записываем JSON чека в файл запроса
		ТекстЗаписи = Новый ЗаписьТекста(ПутьКФайлуЗапроса, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать(исходящийJSON);
		ТекстЗаписи.Закрыть();
		
		// 3. Создаем файл команды (триггер)
		ТекстЗаписи = Новый ЗаписьТекста(ФайлКомандыПечати, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать("");
		ТекстЗаписи.Закрыть();
		
		// 4. Ждем появления файла с ответом
		ВремяНачала = ТекущаяДата();
		Пока Истина Цикл
			Файл = Новый Файл(ПутьКФайлуОтвета);
			Если Файл.Существует() Тогда
				Ждать(0.2);
				Прервать;
			КонецЕсли;
			
			Если ТекущаяДата() - ВремяНачала > Таймаут Тогда
				КодОшибки = -1;
				описаниеОшибки = "Таймаут ожидания ответа";
				Возврат Ложь;
			КонецЕсли;
			
			Ждать(0.1);
		КонецЦикла;
		
		// 5. Читаем и парсим ответ
		ЧтениеТекста = Новый ЧтениеТекста(ПутьКФайлуОтвета, КодировкаТекста.UTF8);
		ТекстJSON = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		ОбъектJSON = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		ответJSON = ОбъектJSON["ответJSON"];
		КодОшибки = ОбъектJSON["кодОшибки"];
		описаниеОшибки = ОбъектJSON["описаниеОшибки"];
		
		// 6. Удаляем файл ответа
		УдалитьФайлы(ПутьКФайлуОтвета);
		
		Возврат (КодОшибки = 0);
		
	Исключение
		КодОшибки = -1;
		описаниеОшибки = "Ошибка: " + ОписаниеОшибки();
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции
```

### Замена в коде печати чека

**Было:**
```bsl
исходящийJSON = СформироватьJSONЧека(всеПараметрыЧека.списПараметровЧека, всеПараметрыЧека.массивЧека, УровеньОтладки);
стрРезПечатиЧека.Вставить("JSONЧека", исходящийJSON);
резПечатиЧека = ВыполнитьЗаданиеJSON(всеПараметрыЧека.COMДрайверККТ10, всеПараметрыЧека.НастройкаиСвязиСКТТ, исходящийJSON, 
			ответJSON, описаниеОшибки, КодОшибки, ?(НеЗакрыватьСоединениеСККТ, ЛОЖЬ, ИСТИНА), ЛОЖЬ);
стрРезПечатиЧека.Вставить("ответJSON", ответJSON);
```

**Стало:**
```bsl
исходящийJSON = СформироватьJSONЧека(всеПараметрыЧека.списПараметровЧека, всеПараметрыЧека.массивЧека, УровеньОтладки);
стрРезПечатиЧека.Вставить("JSONЧека", исходящийJSON);
резПечатиЧека = ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки);
стрРезПечатиЧека.Вставить("ответJSON", ответJSON);
```

## Алгоритм работы программы на Delphi

1. **Таймер команд** (TimerForCommandsFrom1c) проверяет наличие файлов команд каждые N секунд
2. При обнаружении файла `print_receipt.cmd`:
   - Вызывается процедура `ProcessPrintReceiptCommand()`
   - Читается JSON из `receipt_request.json`
   - Вызывается `ExecuteReceiptJSON()` для выполнения команды на ККТ
3. **Функция ExecuteReceiptJSON**:
   - Подключается к ККТ (если не эмуляция)
   - Выполняет `fptr.processJson()` с переданным JSON
   - Получает ответ от драйвера
   - Отключается от ККТ
4. **Формирование ответа**:
   - Создается JSON объект с полями: ответJSON, кодОшибки, описаниеОшибки
   - Сохраняется в файл `receipt_response.json`
5. **Очистка**:
   - Удаляется файл команды `print_receipt.cmd`
   - Удаляется файл запроса `receipt_request.json`

## Параметры и настройки

### В программе Delphi

- **Эмуляция ККТ**: Если включена, команды выполняются без реального подключения к ККТ
- **COM порт**: Номер COM порта для подключения к ККТ (или USB, если 0)
- **Часовой пояс**: Устанавливается из ComboBoxTimeZone

### Обработка ошибок

Коды ошибок:
- **0** - успешное выполнение
- **> 0** - ошибка от драйвера ККТ (код и описание из fptr.errorCode)
- **-1** - критическая ошибка или исключение

## Логирование

Все операции логируются в:
- **Memo на форме** (LogsMemo)
- **Файл лога** в папке `c:\share\checkmarks\logs\`

Пример лог-записей:
```
[12:34:56] Получена команда от 1С: print_receipt
[12:34:56] → Команда: ПЕЧАТЬ ЧЕКА (JSON)
[12:34:56] === ОБРАБОТКА КОМАНДЫ ПЕЧАТИ ЧЕКА ===
[12:34:56] Прочитан JSON чека, размер: 1234 символов
[12:34:56] === ВЫПОЛНЕНИЕ JSON КОМАНДЫ ===
[12:34:57] JSON команда выполнена успешно
[12:34:57] ✓ Печать чека выполнена успешно
[12:34:57] ✓ Результат сохранен в файл
```

## Тестирование

### Ручное тестирование

1. Запустите Delphi программу
2. Создайте файл `c:\share\checkmarks\receipt_request.json` с JSON чека
3. Создайте файл команды `c:\share\checkmarks\commands\print_receipt.cmd`
4. Проверьте появление файла `c:\share\checkmarks\receipt_response.json`
5. Проверьте логи программы

### Пример JSON чека (минимальный)

**Запрос (openShift):**
```json
{
  "type": "openShift",
  "electronically": false,
  "operator": {
    "name": "Иванов И.И.",
    "vatin": "123456789012"
  }
}
```

**Ответ в режиме эмуляции:**
```json
{
  "fiscalParams": {
    "fiscalDocumentDateTime": "2024-10-16T14:30:00+03:00",
    "fiscalDocumentNumber": 1,
    "fiscalDocumentSign": "1234567890",
    "fnNumber": "9999078900000961",
    "registrationNumber": "0000000001002292",
    "shiftNumber": 12
  },
  "warnings": ""
}
```

**Ответ для sell/sellReturn (с дополнительными параметрами):**
```json
{
  "fiscalParams": {
    "fiscalDocumentDateTime": "2024-10-16T14:30:00+03:00",
    "fiscalDocumentNumber": 123,
    "fiscalDocumentSign": "1494325660",
    "fiscalReceiptNumber": 1,
    "fnNumber": "9999078900000961",
    "registrationNumber": "0000000001002292",
    "shiftNumber": 12,
    "total": 72.34,
    "fnsUrl": "www.nalog.gov.ru"
  },
  "warnings": ""
}
```

## Требования

1. **Delphi программа должна быть запущена**
2. **Таймер TimerForCommandsFrom1c должен быть включен**
3. **Папка c:\share\checkmarks\ должна существовать и быть доступна для записи**
4. **Драйвер АТОЛ должен быть установлен** (AddIn.Fptr10)
5. **ККТ должна быть подключена** (или включен режим эмуляции)

## Преимущества решения

✅ **Простота интеграции** - минимальные изменения в коде 1С  
✅ **Независимость** - 1С не работает напрямую с COM-объектом ККТ  
✅ **Отказоустойчивость** - таймауты и обработка ошибок  
✅ **Логирование** - полная трассировка операций  
✅ **Эмуляция** - возможность тестирования без реального оборудования  

## Устранение проблем

### Проблема: Таймаут ожидания ответа

**Причины:**
- Delphi программа не запущена
- Таймер команд отключен
- Ошибка при выполнении команды

**Решение:**
- Проверьте, что программа запущена
- Проверьте логи программы
- Увеличьте таймаут в 1С (по умолчанию 60 сек)

### Проблема: Ошибка чтения файла

**Причины:**
- Нет прав доступа к папке
- Папка не существует
- Файл заблокирован другим процессом

**Решение:**
- Создайте папку вручную
- Проверьте права доступа
- Перезапустите программы

### Проблема: Ошибка подключения к ККТ

**Причины:**
- ККТ не подключена
- Неверный COM порт
- Драйвер не установлен

**Решение:**
- Проверьте физическое подключение ККТ
- Проверьте номер COM порта
- Используйте режим эмуляции для тестирования

