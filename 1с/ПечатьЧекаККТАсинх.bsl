// Модуль для асинхронной проверки маркировки из 1С
// Использует API: /api/check-marking-code-async

//// Переменные для хранения состояния проверки
//Перем ТекущийИдентификаторЗадачи;
//Перем ТекущаяПопытка;
//Перем МаксимальноеКоличествоПопыток;
//Перем ОбработчикЗавершения;

// ==========================================
// ОСНОВНАЯ ФУНКЦИЯ
// ==========================================

// Асинхронная проверка марок на ККТ (через файловую систему)
// Параметры:
//   МассивМарок - Массив - массив кодов маркировки для проверки
//   ТипОперации - Строка - тип операции: "sell", "return", "buyReturn" (по умолчанию "sell")
//   МаксимумПопыток - Число - максимум попыток получения результата (по умолчанию 30 = 60 секунд)
//   ОбработчикРезультата - Строка - имя процедуры для обработки результата (необязательно)
// Возвращаемое значение:
//   Строка - идентификатор задачи (taskId) или пустая строка при ошибке
//
Функция ПроверитьМаркуНаККТ(МассивМарок, ТипОперации = "sell", МаксимумПопыток = 30, ОбработчикРезультата = "") Экспорт    
    // Генерируем уникальный taskId (timestamp + случайное число)
    ГенераторСлучайных = Новый ГенераторСлучайныхЧисел();
    СлучайноеЧисло = ГенераторСлучайных.СлучайноеЧисло(10000, 99999);
    ТекущийИдентификаторЗадачи = Формат(ТекущаяДата(), "ДФ='yyyyMMddHHmmss'") + "_" + Формат(СлучайноеЧисло, "ЧГ=0");
    
    // Подготовка данных
    Данные = Новый Структура;
    Данные.Вставить("markingCodes", МассивМарок);
    Данные.Вставить("sellOrReturn", ТипОперации);
    
    // Преобразуем в JSON
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Данные);
    ДанныеJSON = ЗаписьJSON.Закрыть();
    
    // Записываем задание в файл
    Попытка
        ПутьКФайлу = "c:\share\tasks\pending\" + ТекущийИдентификаторЗадачи + ".json";
        
        // Создаем директорию, если её нет
        Файл = Новый Файл(ПутьКФайлу);
        Если Не Файл.Существует() Тогда
            СоздатьКаталог("c:\share\tasks\pending\");
        КонецЕсли;
        
        // Записываем файл
        ЗаписьТекста = Новый ЗаписьТекста(ПутьКФайлу, КодировкаТекста.UTF8);
        ЗаписьТекста.Записать(ДанныеJSON);
        ЗаписьТекста.Закрыть();
        
    Исключение
        Сообщить("Ошибка записи файла задания: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
    
    Сообщить("Проверка марок запущена. ID: " + ТекущийИдентификаторЗадачи);
    Сообщить("Файл задания: " + ПутьКФайлу);
    
    Возврат ТекущийИдентификаторЗадачи;    
КонецФункции