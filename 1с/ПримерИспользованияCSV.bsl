// =====================================================
// ПРИМЕР ИСПОЛЬЗОВАНИЯ: Проверка марок через CSV
// =====================================================
// Этот файл демонстрирует полный цикл работы с марками

Процедура ТестПроверкиМарокЧерезCSV() Экспорт
    
    Сообщить("=== ТЕСТ ПРОВЕРКИ МАРОК ЧЕРЕЗ CSV ===");
    Сообщить("");
    
    // ШАГ 1: Подготовка данных
    Сообщить("Шаг 1: Подготовка тестовых данных...");
    
    МассивМарок = Новый Массив;
    
    // Марка 1
    Марка1 = Новый Структура;
    Марка1.Вставить("Позиция", 1);
    
    // КОДИРУЕМ МАРКУ В BASE64
    МаркаОбычная = "014494550435306821QXYXSALGLMYQQ" + Символ(29) + "91EE06";
    ЗаписьДанных = Новый ЗаписьДанных();
    ЗаписьДанных.ЗаписатьСимволы(МаркаОбычная);
    МаркаBase64 = Base64Строка(ЗаписьДанных.ЗакрытьИПолучитьДвоичныеДанные());
    
    Марка1.Вставить("КодМаркировкиBase64", МаркаBase64);
    Марка1.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка1);
    
    // Марка 2 (используем функцию кодирования)
    Марка2 = Новый Структура;
    Марка2.Вставить("Позиция", 2);
    Марка2.Вставить("КодМаркировкиBase64", ЗакодироватьМаркуВBase64("01047510084300422152yWbQ" + Символ(29) + "930Hw+"));
    Марка2.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка2);
    
    // Марка 3 (используем функцию кодирования)
    Марка3 = Новый Структура;
    Марка3.Вставить("Позиция", 3);
    Марка3.Вставить("КодМаркировкиBase64", ЗакодироватьМаркуВBase64("01047510084300422152yWbQ" + Символ(29) + "931Hw+"));
    Марка3.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка3);
    
    // Параметры чека
    ПараметрыЧека = Новый Структура;
    ПараметрыЧека.Вставить("ТипЧека", "sell");
    ПараметрыЧека.Вставить("ИмяКассира", "Иванов Иван Иванович");
    ПараметрыЧека.Вставить("ТаймЗона", 6);
    
    Сообщить("✓ Подготовлено марок: " + Формат(МассивМарок.Количество(), "ЧГ=0"));
    Сообщить("");
    
    // ШАГ 2: Запись CSV файлов
    Сообщить("Шаг 2: Запись CSV файлов...");
    
    Если ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Тогда
        Сообщить("✓ CSV файлы успешно записаны");
        Сообщить("");
        Сообщить(">>> ТЕПЕРЬ ЗАПУСТИТЕ DELPHI ПРОГРАММУ <<<");
        Сообщить(">>> 1. Нажмите 'Загрузить данные' <<<");
        Сообщить(">>> 2. Проверьте марки на ККТ <<<");
        Сообщить(">>> 3. Нажмите 'Сохранить результаты' <<<");
        Сообщить("");
        Сообщить("После обработки в Delphi, запустите функцию:");
        Сообщить("  ПрочитатьИОбработатьРезультаты()");
    Иначе
        Сообщить("✗ Ошибка записи CSV файлов");
        Возврат;
    КонецЕсли;
    
КонецПроцедуры


Процедура ПрочитатьИОбработатьРезультаты() Экспорт
    
    Сообщить("=== ЧТЕНИЕ РЕЗУЛЬТАТОВ ===");
    Сообщить("");
    
    // Читаем результаты
    Результаты = ПрочитатьРезультатыПроверки();
    
    Если Результаты.Количество() = 0 Тогда
        Сообщить("⚠ Результаты не найдены");
        Сообщить("  Проверьте, что Delphi программа обработала марки");
        Возврат;
    КонецЕсли;
    
    Сообщить("--- РЕЗУЛЬТАТЫ ПРОВЕРКИ МАРОК ---");
    Сообщить("");
    
    УспешныхПроверок = 0;
    НеуспешныхПроверок = 0;
    
    Для Каждого Рез Из Результаты Цикл
        Сообщить("Позиция: " + Формат(Рез.Позиция, "ЧГ=0"));
        Сообщить("Марка Base64: " + Рез.КодМаркировкиBase64);
        Сообщить("Код результата ККТ: " + Формат(Рез.КодПроверкиККТ, "ЧГ=0"));
        Сообщить("Результат валидации: " + Формат(Рез.ValidationResult, "ЧГ=0"));
        Сообщить("Описание: " + Рез.ОписаниеРезультатаККТ);
        
        // ValidationResult = 15 означает успешную проверку
        Если Рез.КодПроверкиККТ = 0 И Рез.ValidationResult = 15 Тогда
            Сообщить("✓ МАРКА ВАЛИДНА");
            УспешныхПроверок = УспешныхПроверок + 1;
        Иначе
            Сообщить("✗ МАРКА НЕВАЛИДНА");
            НеуспешныхПроверок = НеуспешныхПроверок + 1;
        КонецЕсли;
        
        // Информация о разрешительном режиме (если есть)
        Если Не ПустаяСтрока(Рез.UUID) Тогда
            Сообщить("  UUID: " + Рез.UUID);
            Сообщить("  TimeStamp: " + Рез.TimeStamp);
        КонецЕсли;
        
        Сообщить("--------------------------------");
        Сообщить("");
    КонецЦикла;
    
    // Итоговая статистика
    Сообщить("=== ИТОГО ===");
    Сообщить("Всего проверено: " + Формат(Результаты.Количество(), "ЧГ=0"));
    Сообщить("Успешных: " + Формат(УспешныхПроверок, "ЧГ=0"));
    Сообщить("Неуспешных: " + Формат(НеуспешныхПроверок, "ЧГ=0"));
    Сообщить("");
    
    // Очистка файлов
    Ответ = Вопрос("Очистить CSV файлы?", РежимДиалогаВопрос.ДаНет);
    Если Ответ = КодВозвратаДиалога.Да Тогда
        ОчиститьCSVФайлы();
    КонецЕсли;
    
КонецПроцедуры


// =====================================================
// ПРИМЕР: Использование команд для управления Delphi
// =====================================================
Процедура ПримерИспользованияКоманд() Экспорт
    
    Сообщить("=== ПРИМЕР ИСПОЛЬЗОВАНИЯ КОМАНД ===");
    Сообщить("");
    
    // 1. Начинаем обработку чека
    Сообщить("Шаг 1: Отправляем команду 'process'");
    ОтправитьКоманду("process");
    Сообщить("→ Delphi программа загрузит марки из CSV");
    Сообщить("");
    
    // Ожидание обработки (в реальности здесь должна быть пауза)
    Сообщить("... Delphi проверяет марки на ККТ ...");
    Сообщить("");
    
    // 2. Чек закрывается - сохраняем результаты
    Сообщить("Шаг 2: Отправляем команду 'closing'");
    ОтправитьКоманду("closing");
    Сообщить("→ Delphi сохранит результаты в CSV");
    Сообщить("");
    
    // 3. Читаем результаты
    Сообщить("Шаг 3: Читаем результаты");
    Результаты = ПрочитатьРезультатыПроверки();
    Сообщить("→ Получено результатов: " + Формат(Результаты.Количество(), "ЧГ=0"));
    Сообщить("");
    
    // 4. Чек закрыт - очищаем данные
    Сообщить("Шаг 4: Отправляем команду 'closed'");
    ОтправитьКоманду("closed");
    Сообщить("→ Delphi очистит все данные");
    Сообщить("");
    
    Сообщить("=== ПРИМЕР ЗАВЕРШЕН ===");
    
КонецПроцедуры


// =====================================================
// ПРИМЕР: Отмена чека
// =====================================================
Процедура ПримерОтменыЧека() Экспорт
    
    Сообщить("=== ОТМЕНА ЧЕКА ===");
    
    // Отправляем команду отмены
    ОтправитьКоманду("cancel");
    
    Сообщить("→ Delphi отменит проверку марки");
    Сообщить("→ Delphi очистит все данные");
    Сообщить("→ Готов к новому чеку");
    
КонецПроцедуры


// =====================================================
// ФУНКЦИЯ: Быстрая проверка одной марки
// =====================================================
// КодМаркировки - обычная марка с Символ(29)
// Функция автоматически закодирует в Base64
//
Функция ПроверитьОднуМарку(КодМаркировки, ИмяКассира = "Кассир", ТипЧека = "sell") Экспорт
    
    МассивМарок = Новый Массив;
    
    Марка = Новый Структура;
    Марка.Вставить("Позиция", 1);
    // Кодируем марку в Base64
    Марка.Вставить("КодМаркировкиBase64", ЗакодироватьМаркуВBase64(КодМаркировки));
    Марка.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
    МассивМарок.Добавить(Марка);
    
    ПараметрыЧека = Новый Структура;
    ПараметрыЧека.Вставить("ТипЧека", ТипЧека);
    ПараметрыЧека.Вставить("ИмяКассира", ИмяКассира);
    ПараметрыЧека.Вставить("ТаймЗона", 6);
    
    Если ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Тогда
        Сообщить("Марка подготовлена для проверки");
        Сообщить("Запустите Delphi программу");
        Возврат Истина;
    Иначе
        Возврат Ложь;
    КонецЕсли;
    
КонецФункции


// =====================================================
// ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ
// =====================================================
//
// ВАРИАНТ 1: Полный тест
// ------------------------
// 1. Выполните: ТестПроверкиМарокЧерезCSV()
// 2. Запустите Delphi программу:
//    - Нажмите "Загрузить данные"
//    - Проверьте марки (автоматически или вручную)
//    - Нажмите "Сохранить результаты"
// 3. Вернитесь в 1С и выполните: ПрочитатьИОбработатьРезультаты()
//
// ВАРИАНТ 2: Быстрая проверка одной марки
// ----------------------------------------
// ПроверитьОднуМарку("014494550435306821QXYXSALGLMYQQ\u001d91EE06", "Иванов И.И.");
//
// ВАРИАНТ 3: Проверка списка марок из документа
// ----------------------------------------------
// МассивМарок = ПолучитьМаркиИзДокумента(ДокументСсылка);
// ПараметрыЧека = ПолучитьПараметрыЧека(ДокументСсылка);
// ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека);
//

