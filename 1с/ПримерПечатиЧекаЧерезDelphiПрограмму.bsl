// ====================================================================
// Пример использования Delphi программы для печати чека через JSON
// ====================================================================

// Вместо вызова:
// резПечатиЧека = ВыполнитьЗаданиеJSON(всеПараметрыЧека.COMДрайверККТ10, всеПараметрыЧека.НастройкаиСвязиСКТТ, исходящийJSON, 
//			ответJSON, описаниеОшибки, КодОшибки, ?(НеЗакрыватьСоединениеСККТ, ЛОЖЬ, ИСТИНА), ЛОЖЬ);

// Используем:
Функция ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки)
	
	Перем ПутьКФайлуЗапроса;
	Перем ПутьКФайлуОтвета;
	Перем ПутьККомандам;
	Перем ФайлКомандыПечати;
	Перем Таймаут;
	Перем ВремяНачала;
	Перем ТекстJSON;
	Перем ОбъектJSON;
	
	ПутьКФайлуЗапроса = "c:\share\checkmarks\receipt_request.json";
	ПутьКФайлуОтвета = "c:\share\checkmarks\receipt_response.json";
	ПутьККомандам = "c:\share\checkmarks\commands\";
	ФайлКомандыПечати = ПутьККомандам + "print_receipt.cmd";
	Таймаут = 60; // Таймаут ожидания ответа в секундах
	
	Попытка
		
		// 1. Удаляем старый файл ответа, если он есть
		Файл = Новый Файл(ПутьКФайлуОтвета);
		Если Файл.Существует() Тогда
			УдалитьФайлы(ПутьКФайлуОтвета);
		КонецЕсли;
		
		// 2. Создаем папку для команд, если её нет
		Файл = Новый Файл(ПутьККомандам);
		Если Не Файл.Существует() Тогда
			СоздатьКаталог(ПутьККомандам);
		КонецЕсли;
		
		// 3. Записываем JSON чека в файл запроса
		ТекстЗаписи = Новый ЗаписьТекста(ПутьКФайлуЗапроса, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать(исходящийJSON);
		ТекстЗаписи.Закрыть();
		
		// 4. Создаем файл команды (пустой файл-триггер для Delphi программы)
		ТекстЗаписи = Новый ЗаписьТекста(ФайлКомандыПечати, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать("");
		ТекстЗаписи.Закрыть();
		
		// 5. Ждем появления файла с ответом
		ВремяНачала = ТекущаяДата();
		Пока Истина Цикл
			
			// Проверяем, появился ли файл ответа
			Файл = Новый Файл(ПутьКФайлуОтвета);
			Если Файл.Существует() Тогда
				// Небольшая задержка, чтобы файл полностью записался
				Ждать(0.2);
				Прервать;
			КонецЕсли;
			
			// Проверяем таймаут
			Если ТекущаяДата() - ВремяНачала > Таймаут Тогда
				КодОшибки = -1;
				описаниеОшибки = "Таймаут ожидания ответа от Delphi программы (" + Формат(Таймаут, "ЧГ=") + " сек)";
				Возврат Ложь;
			КонецЕсли;
			
			// Небольшая задержка перед следующей проверкой
			Ждать(0.1);
			
		КонецЦикла;
		
		// 6. Читаем ответ из файла
		ЧтениеТекста = Новый ЧтениеТекста(ПутьКФайлуОтвета, КодировкаТекста.UTF8);
		ТекстJSON = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
		
		// 7. Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		ОбъектJSON = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// 8. Извлекаем данные из ответа
		ответJSON = ОбъектJSON["ответJSON"];
		КодОшибки = ОбъектJSON["кодОшибки"];
		описаниеОшибки = ОбъектJSON["описаниеОшибки"];
		
		// 9. Удаляем файл ответа после обработки
		Попытка
			УдалитьФайлы(ПутьКФайлуОтвета);
		Исключение
			// Игнорируем ошибки удаления
		КонецПопытки;
		
		// 10. Возвращаем результат
		Возврат (КодОшибки = 0);
		
	Исключение
		КодОшибки = -1;
		описаниеОшибки = "Ошибка взаимодействия с Delphi программой: " + ОписаниеОшибки();
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// ====================================================================
// ИСПОЛЬЗОВАНИЕ В КОДЕ ПЕЧАТИ ЧЕКА
// ====================================================================

Процедура ПримерИспользования()
	
	Перем всеПараметрыЧека;
	Перем стрРезПечатиЧека;
	Перем исходящийJSON;
	Перем ответJSON;
	Перем описаниеОшибки;
	Перем КодОшибки;
	Перем резПечатиЧека;
	Перем УровеньОтладки;
	
	// ... подготовка параметров чека ...
	
	// Формируем JSON чека
	исходящийJSON = СформироватьJSONЧека(всеПараметрыЧека.списПараметровЧека, всеПараметрыЧека.массивЧека, УровеньОтладки);
	стрРезПечатиЧека.Вставить("JSONЧека", исходящийJSON);
	
	// ЗАМЕНЯЕМ СТРОКУ:
	// резПечатиЧека = ВыполнитьЗаданиеJSON(...);
	
	// НА:
	резПечатиЧека = ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки);
	
	стрРезПечатиЧека.Вставить("ответJSON", ответJSON);
	
	// Проверяем результат
	Если Не резПечатиЧека Тогда
		Сообщить("Ошибка печати чека: [" + Формат(КодОшибки, "ЧГ=") + "] " + описаниеОшибки);
	Иначе
		Сообщить("Чек распечатан успешно");
	КонецЕсли;
	
КонецПроцедуры

// ====================================================================
// ПРИМЕЧАНИЯ
// ====================================================================

// 1. Убедитесь, что Delphi программа запущена и таймеры включены
// 2. Папка c:\share\checkmarks должна быть доступна для записи
// 3. Таймаут можно увеличить при печати сложных чеков (по умолчанию 60 сек)
// 4. Функция возвращает ИСТИНА при успешной печати (КодОшибки = 0)
// 5. В случае ошибки возвращается ЛОЖЬ, а в КодОшибки и описаниеОшибки записываются детали

