// =====================================================
// Модуль для проверки маркировки через CSV файлы
// =====================================================
// Delphi программа читает CSV файлы, проверяет марки на ККТ
// и записывает результаты в выходной CSV файл

// Пути к CSV файлам
Перем ПутьВходнойФайлМарок;      // input_marks.csv
Перем ПутьВходнойФайлПараметров; // input_params.csv
Перем ПутьВыходнойФайлРезультаты; // output_results.csv

// =====================================================
// ФУНКЦИЯ: Записать марки в CSV файл для проверки
// =====================================================
// Параметры:
//   МассивМарок - Массив структур - массив марок для проверки
//     Структура марки:
//       .Позиция - Число - номер позиции
//       .КодМаркировкиBase64 - Строка - код маркировки закодированный в Base64
//         ВАЖНО: Delphi декодирует Base64 автоматически!
//         Пример: "MDE0NDk0NTUwNDM1MzA2ODIxUVhZWFNBTEdMTVlRURw5MUVFMDYcOTJZV0NYYm1LNlNOOHZ2d294WkZrN1dBWThXb0pOTUdHcjZDZ3RpdWphMDRjPQ=="
//       .ПланируемыйСтатус - Строка - планируемый статус марки
//   ПараметрыЧека - Структура - параметры чека
//       .ТипЧека - Строка - "sell" или "return"
//       .ИмяКассира - Строка - имя кассира
//       .ТаймЗона - Число - часовой пояс (по умолчанию 6)
// Возвращаемое значение:
//   Булево - Истина, если файлы успешно записаны
//
Функция ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Экспорт
    
    ПутьВходнойФайлМарок = "c:\share\checkmarks\input_marks.csv";
    ПутьВходнойФайлПараметров = "c:\share\checkmarks\input_params.csv";
    
    Попытка
        // Создаем директорию, если её нет
        КаталогShare = "c:\share\";
        Файл = Новый Файл(КаталогShare);
        Если Не Файл.Существует() Тогда
            СоздатьКаталог(КаталогShare);
        КонецЕсли;
        
        // === ЗАПИСЫВАЕМ ФАЙЛ С МАРКАМИ ===
        ЗаписьМарок = Новый ЗаписьТекста(ПутьВходнойФайлМарок, КодировкаТекста.UTF8);
        
        // Заголовок
        ЗаписьМарок.ЗаписатьСтроку("Position;MarkCode;PlannedStatus");
        
        // Данные
        Для Каждого Марка Из МассивМарок Цикл
            Строка = Формат(Марка.Позиция, "ЧГ=0") + ";" + 
                     Марка.КодМаркировкиBase64 + ";" + 
                     Марка.ПланируемыйСтатус;
            ЗаписьМарок.ЗаписатьСтроку(Строка);
        КонецЦикла;
        
        ЗаписьМарок.Закрыть();
        
        // === ЗАПИСЫВАЕМ ФАЙЛ С ПАРАМЕТРАМИ ===
        ЗаписьПараметров = Новый ЗаписьТекста(ПутьВходнойФайлПараметров, КодировкаТекста.UTF8);
        
        // Заголовок
        ЗаписьПараметров.ЗаписатьСтроку("CheckType;CashierName;TimeZone");
        
        // Данные
        ТипЧека = ПараметрыЧека.ТипЧека;
        ИмяКассира = ПараметрыЧека.ИмяКассира;
        ТаймЗона = ?(ПараметрыЧека.Свойство("ТаймЗона"), ПараметрыЧека.ТаймЗона, 6);
        
        Строка = ТипЧека + ";" + ИмяКассира + ";" + Формат(ТаймЗона, "ЧГ=0");
        ЗаписьПараметров.ЗаписатьСтроку(Строка);
        
        ЗаписьПараметров.Закрыть();
        
        Сообщить("✓ CSV файлы записаны успешно");
        Сообщить("  Марок: " + Формат(МассивМарок.Количество(), "ЧГ=0"));
        Сообщить("  Файл марок: " + ПутьВходнойФайлМарок);
        Сообщить("  Файл параметров: " + ПутьВходнойФайлПараметров);
        
        Возврат Истина;
        
    Исключение
        Сообщить("✗ Ошибка записи CSV файлов: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции


// =====================================================
// ФУНКЦИЯ: Прочитать результаты проверки из CSV файла
// =====================================================
// Возвращаемое значение:
//   Массив структур - массив результатов проверки марок
//     Структура результата:
//       .Позиция - Число
//       .КодМаркировкиBase64 - Строка - код марки в Base64
//       .КодПроверкиККТ - Число - код ошибки (0 = успех)
//       .ОписаниеРезультатаККТ - Строка
//       .ValidationResult - Число - результат валидации (15 = OK)
//       .КодПроверкиРазрешительногоРежима - Число
//       .ОписаниеРезультатаРазрешительногоРежима - Строка
//       .UUID - Строка
//       .TimeStamp - Строка
//       .Inst - Строка
//       .Ver - Строка
//
Функция ПрочитатьРезультатыПроверки() Экспорт
    
    ПутьВыходнойФайлРезультаты = "c:\share\checkmarks\output_results.csv";
    
    МассивРезультатов = Новый Массив;
    
    Попытка
        // Проверяем существование файла
        Файл = Новый Файл(ПутьВыходнойФайлРезультаты);
        Если Не Файл.Существует() Тогда
            Сообщить("⚠ Файл результатов не найден: " + ПутьВыходнойФайлРезультаты);
            Возврат МассивРезультатов;
        КонецЕсли;
        
        // Читаем файл
        ЧтениеТекста = Новый ЧтениеТекста(ПутьВыходнойФайлРезультаты, КодировкаТекста.UTF8);
        
        // Пропускаем заголовок
        ЗаголовокСтрока = ЧтениеТекста.ПрочитатьСтроку();
        
        // Читаем данные
        Пока Истина Цикл
            СтрокаДанных = ЧтениеТекста.ПрочитатьСтроку();
            Если СтрокаДанных = Неопределено Тогда
                Прервать;
            КонецЕсли;
            
            Если ПустаяСтрока(СокрЛП(СтрокаДанных)) Тогда
                Продолжить;
            КонецЕсли;
            
            // Разбираем строку по разделителю ";"
            Поля = СтрРазделить(СтрокаДанных, ";", Ложь);
            
            Если Поля.Количество() < 11 Тогда
                Продолжить;
            КонецЕсли;
            
            // Создаем структуру результата
            Результат = Новый Структура;
            Результат.Вставить("Позиция", Число(Поля[0]));
            Результат.Вставить("КодМаркировкиBase64", СокрЛП(Поля[1]));
            Результат.Вставить("КодПроверкиККТ", Число(Поля[2]));
            Результат.Вставить("ОписаниеРезультатаККТ", СокрЛП(Поля[3]));
            Результат.Вставить("ValidationResult", Число(Поля[4]));
            Результат.Вставить("КодПроверкиРазрешительногоРежима", Число(Поля[5]));
            Результат.Вставить("ОписаниеРезультатаРазрешительногоРежима", СокрЛП(Поля[6]));
            Результат.Вставить("UUID", СокрЛП(Поля[7]));
            Результат.Вставить("TimeStamp", СокрЛП(Поля[8]));
            Результат.Вставить("Inst", СокрЛП(Поля[9]));
            Результат.Вставить("Ver", СокрЛП(Поля[10]));
            
            МассивРезультатов.Добавить(Результат);
        КонецЦикла;
        
        ЧтениеТекста.Закрыть();
        
        Сообщить("✓ Результаты прочитаны из CSV");
        Сообщить("  Записей: " + Формат(МассивРезультатов.Количество(), "ЧГ=0"));
        
        Возврат МассивРезультатов;
        
    Исключение
        Сообщить("✗ Ошибка чтения CSV файла результатов: " + ОписаниеОшибки());
        Возврат МассивРезультатов;
    КонецПопытки;
    
КонецФункции


// =====================================================
// ФУНКЦИЯ: Кодировать марку в Base64
// =====================================================
// Параметры:
//   МаркаОбычная - Строка - код маркировки (с Символ(29))
// Возвращаемое значение:
//   Строка - код маркировки в Base64
//
Функция ЗакодироватьМаркуВBase64(МаркаОбычная) Экспорт
    
    Попытка
        ЗаписьДанных = Новый ЗаписьДанных();
        ЗаписьДанных.ЗаписатьСимволы(МаркаОбычная);
        МаркаBase64 = Base64Строка(ЗаписьДанных.ЗакрытьИПолучитьДвоичныеДанные());
        
        Возврат МаркаBase64;
        
    Исключение
        Сообщить("Ошибка кодирования в Base64: " + ОписаниеОшибки());
        Возврат МаркаОбычная; // Возвращаем как есть
    КонецПопытки;
    
КонецФункции


// =====================================================
// ФУНКЦИЯ: Удалить CSV файлы после обработки
// =====================================================
Функция ОчиститьCSVФайлы() Экспорт
    
    Попытка
        Файл1 = Новый Файл("c:\share\checkmarks\input_marks.csv");
        Если Файл1.Существует() Тогда
            УдалитьФайлы("c:\share\checkmarks\input_marks.csv");
        КонецЕсли;
        
        Файл2 = Новый Файл("c:\share\checkmarks\input_params.csv");
        Если Файл2.Существует() Тогда
            УдалитьФайлы("c:\share\checkmarks\input_params.csv");
        КонецЕсли;
        
        Файл3 = Новый Файл("c:\share\checkmarks\output_results.csv");
        Если Файл3.Существует() Тогда
            УдалитьФайлы("c:\share\checkmarks\output_results.csv");
        КонецЕсли;
        
        Сообщить("✓ CSV файлы очищены");
        Возврат Истина;
        
    Исключение
        Сообщить("⚠ Ошибка при очистке CSV файлов: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции


// =====================================================
// ПРИМЕР ИСПОЛЬЗОВАНИЯ
// =====================================================
//
// // 1. Подготовка данных
// МассивМарок = Новый Массив;
//
// Марка1 = Новый Структура;
// Марка1.Вставить("Позиция", 1);
// // Кодируем марку в Base64
// МаркаОбычная = "014494550435306821QXYXSALGLMYQQ" + Символ(29) + "91EE06";
// Марка1.Вставить("КодМаркировкиBase64", ЗакодироватьМаркуВBase64(МаркаОбычная));
// Марка1.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
// МассивМарок.Добавить(Марка1);
//
// Марка2 = Новый Структура;
// Марка2.Вставить("Позиция", 2);
// Марка2.Вставить("КодМаркировкиBase64", ЗакодироватьМаркуВBase64("01234567890..." + Символ(29) + "91EE07"));
// Марка2.Вставить("ПланируемыйСтатус", "штучный товар, реализован");
// МассивМарок.Добавить(Марка2);
//
// ПараметрыЧека = Новый Структура;
// ПараметрыЧека.Вставить("ТипЧека", "sell");
// ПараметрыЧека.Вставить("ИмяКассира", "Иванов И.И.");
// ПараметрыЧека.Вставить("ТаймЗона", 6);
//
// // 2. Записываем CSV файлы
// Если ЗаписатьМаркиДляПроверки(МассивМарок, ПараметрыЧека) Тогда
//     Сообщить("CSV файлы готовы для Delphi программы");
//     Сообщить("Теперь запустите Delphi программу для обработки");
// КонецЕсли;
//
// // 3. После обработки Delphi программой - читаем результаты
// Результаты = ПрочитатьРезультатыПроверки();
//
// Для Каждого Рез Из Результаты Цикл
//     Сообщить("Позиция " + Рез.Позиция + ": " + Рез.ОписаниеРезультатаККТ);
//     Если Рез.КодПроверкиККТ = 0 И Рез.ValidationResult = 15 Тогда
//         Сообщить("  ✓ Марка валидна");
//     Иначе
//         Сообщить("  ✗ Марка невалидна");
//     КонецЕсли;
// КонецЦикла;
//
// // 4. Очистка файлов
// ОчиститьCSVФайлы();

