//==================================================================================
// НОВАЯ ВЕРСИЯ: Печать чека через Delphi программу (взамен прямого COM-объекта)
//==================================================================================
ответJSON = "";
описаниеОшибки = ""; КодОшибки = 0;
исходящийJSON = СформироватьJSONЧека(всеПараметрыЧека.списПараметровЧека, всеПараметрыЧека.массивЧека, УровеньОтладки);
стрРезПечатиЧека.Вставить("JSONЧека", исходящийJSON);

// НОВЫЙ СПОСОБ: Через Delphi программу (файловый обмен)
резПечатиЧека = ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки);

// СТАРЫЙ СПОСОБ (закомментирован, оставлен для справки):
// резПечатиЧека = ВыполнитьЗаданиеJSON(всеПараметрыЧека.COMДрайверККТ10, всеПараметрыЧека.НастройкаиСвязиСКТТ, исходящийJSON, 
//			ответJSON, описаниеОшибки, КодОшибки, ?(НеЗакрыватьСоединениеСККТ, ЛОЖЬ, ИСТИНА), ЛОЖЬ);

стрРезПечатиЧека.Вставить("ответJSON", ответJSON);
//==================================================================================							   


функция ВыполнитьЗаданиеJSON(COMДрайверККТ10, НастройкаиСвязиСКТТ, JSONЗадание, ОтветJSON, описаниеОшибки = "", 
	КодОшибки = 0, ПодключатьсяКККТ = ИСТИНА, 
		НеЗакрыватьСоединениеСККТ = FALSE) экспорт
УровеньОтладки = ПолучитьЗначениеНастройки(НастройкаиСвязиСКТТ, "УровеньОтладки");
ФлТестовыйРежим = ПолучитьЗначениеНастройки(НастройкаиСвязиСКТТ, "ФлТестовыйРежим");
Time_Zone = ПолучитьЗначениеНастройки(НастройкаиСвязиСКТТ, "ЧасоваяЗона");

Если УровеньОтладки >= 3 тогда
Сообщить("начало: ВыполнитьЗаданиеJSON");	
Сообщить("JSONЗадание="+СокрЛП(JSONЗадание));
конецЕсли;			
рез = ИСТИНА;
ОтветJSON = "";
Если ПодключатьсяКККТ тогда
резПодкл = Подключиться(COMДрайверККТ10, НастройкаиСвязиСКТТ, описаниеОшибки, КодОшибки);
Если НЕ резПодкл тогда
стрОшибки = описаниеОшибки;
Если уровеньОтладки >=2 тогда
Сообщить(стрОшибки);
конецЕсли;
ЗалогироватьОпреацию(0, "Подключение ККТ в ВыполнитьЗаданиеJSON", УровеньОтладки, False, КодОшибки, стрОшибки);
рез = ЛОЖЬ;
Если уровеньОтладки >= 3 тогда
Сообщить("конец: ВыполнитьЗаданиеJSON");	
конецЕсли;					
Возврат рез;
конецЕсли;	
конецЕсли;

резПровКоманды = 0;
Если УровеньОтладки >= 3 тогда
COMДрайверККТ10.setParam(COMДрайверККТ10.LIBFPTR_PARAM_JSON_DATA, JSONЗадание);
резПровКоманды = COMДрайверККТ10.validateJson();
конецЕсли;  
Если резПровКоманды <> 0 тогда                                          
ЛокОписаниеОшибки = COMДрайверККТ10.errorDescription();
Если Найти(ЛокОписаниеОшибки, "validateTask") > 0 тогда
резПровКоманды = 0;
//флТестовыйРежим = ЛОЖЬ;
конецЕсли;
конецЕсли;
Если резПровКоманды <> 0 тогда
кодОшибки = COMДрайверККТ10.errorCode();
описаниеОшибки = COMДрайверККТ10.errorDescription();          		
Если УровеньОтладки >=2 тогда
Сообщить(описаниеОшибки);
конецЕсли;
ЗалогироватьОпреацию(0, "проверить корректность JSON в ВыполнитьЗаданиеJSON", УровеньОтладки, False, КодОшибки, описаниеОшибки);
рез = ЛОЖЬ;                                               
конецЕсли;		                                                  	

Если УровеньОтладки >=3 тогда
Сообщить("Выполнение json задания...");
конецЕсли;				

//COMДрайверККТ10.setSingleSetting(COMДрайверККТ10.LIBFPTR_SETTING_TIME_ZONE, COMДрайверККТ10.LIBFPTR_TIME_ZONE_6);
COMДрайверККТ10.setSingleSetting(COMДрайверККТ10.LIBFPTR_SETTING_TIME_ZONE, Time_Zone);
COMДрайверККТ10.applySingleSettings();

Если резПровКоманды = 0 тогда    
резВыпКоманды = 0;
Если Не ФлТестовыйРежим тогда
COMДрайверККТ10.setParam(COMДрайверККТ10.LIBFPTR_PARAM_JSON_DATA, JSONЗадание);
резВыпКоманды = COMДрайверККТ10.processJson();
конецЕсли;
Если резВыпКоманды <> 0 тогда
кодОшибки = COMДрайверККТ10.errorCode();
описаниеОшибки = COMДрайверККТ10.errorDescription();          		
Если УровеньОтладки >=2 тогда
Сообщить(описаниеОшибки);
конецЕсли;
ЗалогироватьОпреацию(0, "ВыполнитьЗаданиеJSON", УровеньОтладки, False, КодОшибки, описаниеОшибки);					
рез = ЛОЖЬ;                                               
иначе                        
Если Не ФлТестовыйРежим тогда
ОтветJSON = COMДрайверККТ10.getParamString(COMДрайверККТ10.LIBFPTR_PARAM_JSON_DATA);
иначе
ОтветJSON = ПолучитьМокОтветНаJSONКомманду(JSONЗадание);
конецЕсли;
конецЕсли;		                                                  
конецЕсли;

Если НЕ НеЗакрыватьСоединениеСККТ тогда
ОписаниеОшибкиОтключения = "";
КодОшибкиОтключения = 0;
резОтключ = Отключиться(COMДрайверККТ10, УровеньОтладки, ФлТестовыйРежим, ОписаниеОшибкиОтключения, КодОшибкиОтключения);
Если НЕ резОтключ тогда
стрОшибки = ОписаниеОшибкиОтключения;
Если УровеньОтладки >=2 тогда
Сообщить(стрОшибки);
конецЕсли;
ЗалогироватьОпреацию(0, "Отключение от ККТ в ВыполнитьЗаданиеJSON", УровеньОтладки, False, КодОшибкиОтключения, стрОшибки);
конецЕсли;        
конецЕсли;
Если УровеньОтладки >= 3 тогда
Сообщить("ОтветJSON="+СокрЛП(ОтветJSON));
Сообщить("конец: ВыполнитьЗаданиеJSON");	
конецЕсли;						
возврат рез;
конецФункции //ВыполнитьЗаданиеJSON

//==================================================================================
// НОВАЯ ФУНКЦИЯ: Выполнение JSON команды через Delphi программу
//==================================================================================
Функция ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(исходящийJSON, ответJSON, описаниеОшибки, КодОшибки) Экспорт
	
	Перем ПутьКФайлуЗапроса;
	Перем ПутьКФайлуОтвета;
	Перем ПутьККомандам;
	Перем ФайлКомандыПечати;
	Перем Таймаут;
	Перем ВремяНачала;
	Перем ТекстJSON;
	Перем ОбъектJSON;
	
	// Пути к файлам для обмена с Delphi программой
	ПутьКФайлуЗапроса = "c:\share\checkmarks\receipt_request.json";
	ПутьКФайлуОтвета = "c:\share\checkmarks\receipt_response.json";
	ПутьККомандам = "c:\share\checkmarks\commands\";
	ФайлКомандыПечати = ПутьККомандам + "print_receipt.cmd";
	Таймаут = 60; // Таймаут ожидания ответа в секундах
	
	Попытка
		
		// 1. Удаляем старый файл ответа, если он есть
		Файл = Новый Файл(ПутьКФайлуОтвета);
		Если Файл.Существует() Тогда
			УдалитьФайлы(ПутьКФайлуОтвета);
		КонецЕсли;
		
		// 2. Создаем папку для команд, если её нет
		Файл = Новый Файл(ПутьККомандам);
		Если Не Файл.Существует() Тогда
			СоздатьКаталог(ПутьККомандам);
		КонецЕсли;
		
		// 3. Записываем JSON чека в файл запроса
		ТекстЗаписи = Новый ЗаписьТекста(ПутьКФайлуЗапроса, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать(исходящийJSON);
		ТекстЗаписи.Закрыть();
		
		// 4. Создаем файл команды (пустой файл-триггер для Delphi программы)
		ТекстЗаписи = Новый ЗаписьТекста(ФайлКомандыПечати, КодировкаТекста.UTF8);
		ТекстЗаписи.Записать("");
		ТекстЗаписи.Закрыть();
		
		// 5. Ждем появления файла с ответом
		ВремяНачала = ТекущаяДата();
		СчетчикСекунд = 0;
		
		Пока Истина Цикл
			
			// Проверяем, появился ли файл ответа
			Файл = Новый Файл(ПутьКФайлуОтвета);
			Если Файл.Существует() Тогда
				Сообщить("✓ Печать чека завершена!");
				// Небольшая задержка, чтобы файл полностью записался
				Прервать;
			КонецЕсли;
			
			// Проверяем таймаут
			Если ТекущаяДата() - ВремяНачала > Таймаут Тогда
				КодОшибки = -1;
				описаниеОшибки = "Таймаут ожидания ответа от Delphi программы (" + Формат(Таймаут, "ЧГ=") + " сек)";
				Сообщить("✗ " + описаниеОшибки);
				Возврат Ложь;
			КонецЕсли;
			
			// Формируем текст сообщения с анимацией
			СчетчикСекунд = СчетчикСекунд + 1;
			ТекстСообщения = "Идёт печать чека";
			
			// Добавляем точки для анимации (1-3 точки)
			КоличествоТочек = СчетчикСекунд % 4;
			Если КоличествоТочек = 0 Тогда
				ТекстСообщения = ТекстСообщения + "   ";
			ИначеЕсли КоличествоТочек = 1 Тогда
				ТекстСообщения = ТекстСообщения + ".  ";
			ИначеЕсли КоличествоТочек = 2 Тогда
				ТекстСообщения = ТекстСообщения + ".. ";
			Иначе
				ТекстСообщения = ТекстСообщения + "...";
			КонецЕсли;
			
			// Добавляем время ожидания
			ТекстСообщения = ТекстСообщения + Символы.ПС + Символы.ПС 
			                + "Прошло: " + Формат(СчетчикСекунд, "ЧГ=") + " сек";
			
			// Показываем диалог с таймаутом 1 секунда
			Кнопки = Новый СписокЗначений;
			Кнопки.Добавить(КодВозвратаДиалога.Отмена, "Отмена");
			
			Ответ = Вопрос(ТекстСообщения, Кнопки, 1, , "Печать чека на ККТ", КодВозвратаДиалога.Отмена);
			
			// Если пользователь нажал "Отмена"
			Если Ответ = КодВозвратаДиалога.Отмена Тогда
				КодОшибки = -2;
				описаниеОшибки = "Операция прервана пользователем";
				Сообщить("✗ " + описаниеОшибки);
				Возврат Ложь;
			КонецЕсли;
			
			// Если Ответ = КодВозвратаДиалога.Таймаут, то продолжаем цикл
			
		КонецЦикла;
		
		// 6. Читаем ответ из файла
		ЧтениеТекста = Новый ЧтениеТекста(ПутьКФайлуОтвета, КодировкаТекста.UTF8);
		ТекстJSON = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
		
		// 7. Парсим JSON ответ
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		ОбъектJSON = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// 8. Извлекаем данные из ответа
		ответJSON = ОбъектJSON["ответJSON"];
		КодОшибки = ОбъектJSON["кодОшибки"];
		описаниеОшибки = ОбъектJSON["описаниеОшибки"];
		
		// 9. Удаляем файл ответа после обработки
		Попытка
			УдалитьФайлы(ПутьКФайлуОтвета);
		Исключение
			// Игнорируем ошибки удаления
		КонецПопытки;
		
		// 10. Возвращаем результат
		Возврат (КодОшибки = 0);
		
	Исключение
		КодОшибки = -1;
		описаниеОшибки = "Ошибка взаимодействия с Delphi программой: " + ОписаниеОшибки();
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции //ВыполнитьЗаданиеJSONЧерезDelphiПрограмму
