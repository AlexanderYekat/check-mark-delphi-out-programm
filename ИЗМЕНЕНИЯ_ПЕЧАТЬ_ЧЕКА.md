# Изменения: Добавлена функция печати чека через JSON

## Дата: 16.10.2025

## Что добавлено

Реализована возможность печати чека на ККТ через передачу JSON команд от 1С в Delphi программу через файловую систему.

## Измененные файлы

### 1. check_marks.pas

#### Добавлены константы:
```pascal
COMMANDS_FROM_1C_PRINT_RECEIPT = 'print_receipt';
CSV_RECEIPT_REQUEST = 'c:\share\checkmarks\receipt_request.json';
CSV_RECEIPT_RESPONSE = 'c:\share\checkmarks\receipt_response.json';
```

#### Добавлены методы:

1. **ExecuteReceiptJSON** - выполнение JSON команды на ККТ
   - Подключение к ККТ
   - Выполнение fptr.processJson()
   - Получение ответа
   - Обработка ошибок

2. **ProcessPrintReceiptCommand** - обработка команды печати от 1С
   - Чтение JSON из файла
   - Вызов ExecuteReceiptJSON
   - Формирование ответа в JSON
   - Сохранение результата в файл

#### Изменения в TimerForCommandsFrom1cTimer:
Добавлена обработка команды `print_receipt`:
```pascal
else if CommandName = COMMANDS_FROM_1C_PRINT_RECEIPT then
begin
  LogMessage('→ Команда: ПЕЧАТЬ ЧЕКА (JSON)');
  ProcessPrintReceiptCommand();
end
```

## Новые файлы

### 1. 1с/ПримерПечатиЧекаЧерезDelphiПрограмму.bsl
- Пример функции для 1С
- Полный код интеграции
- Примеры использования

### 2. 1с/ИНСТРУКЦИЯ_ПЕЧАТЬ_ЧЕКА.md
- Подробная инструкция
- Схема работы
- Примеры кода
- Устранение проблем

## Схема работы

```
1С:
1. Формирует JSON чека через СформироватьJSONЧека()
2. Сохраняет в c:\share\checkmarks\receipt_request.json
3. Создает файл команды c:\share\checkmarks\commands\print_receipt.cmd
4. Ожидает появления файла c:\share\checkmarks\receipt_response.json
5. Читает результат из файла ответа

Delphi:
1. Таймер обнаруживает файл команды print_receipt.cmd
2. Читает JSON из receipt_request.json
3. Выполняет fptr.processJson()
4. Формирует JSON ответ с кодом и описанием ошибки
5. Сохраняет в receipt_response.json
6. Удаляет файлы команды и запроса
```

## Формат файлов

### receipt_request.json
```json
{JSON чека от драйвера АТОЛ}
```

### receipt_response.json
```json
{
  "ответJSON": "{ответ от драйвера}",
  "кодОшибки": 0,
  "описаниеОшибки": "OK"
}
```

## Использование в 1С

### Было:
```bsl
резПечатиЧека = ВыполнитьЗаданиеJSON(
    всеПараметрыЧека.COMДрайверККТ10, 
    всеПараметрыЧека.НастройкаиСвязиСКТТ, 
    исходящийJSON, 
    ответJSON, 
    описаниеОшибки, 
    КодОшибки, 
    ?(НеЗакрыватьСоединениеСККТ, ЛОЖЬ, ИСТИНА), 
    ЛОЖЬ);
```

### Стало:
```bsl
резПечатиЧека = ВыполнитьЗаданиеJSONЧерезDelphiПрограмму(
    исходящийJSON, 
    ответJSON, 
    описаниеОшибки, 
    КодОшибки);
```

## Особенности реализации

1. **Автоматическое подключение/отключение от ККТ**
   - Программа сама управляет соединением
   - После выполнения команды соединение закрывается

2. **Поддержка эмуляции с реалистичными мок-ответами**
   - При включенной эмуляции команды не выполняются на реальной ККТ
   - Возвращаются реалистичные фискальные данные в зависимости от типа операции:
     * **sell/sellReturn** - чек продажи/возврата с fiscalParams
     * **openShift** - открытие смены
     * **closeShift** - закрытие смены
     * Другие операции - простой ответ OK
   - Мок-ответы содержат:
     * Фискальную дату/время (текущее время)
     * Номер документа, признак документа
     * Номер ФН, регистрационный номер ККТ
     * Номер смены, сумму чека
     * URL ФНС для проверки

3. **Обработка ошибок**
   - Все ошибки логируются
   - Возвращаются коды и описания ошибок
   - Обработка исключений

4. **Таймауты с диалогом**
   - В 1С настраивается таймаут ожидания (по умолчанию 60 сек)
   - Показывается диалог с прогрессом и возможностью отмены
   - Анимация процесса печати
   - Защита от зависания

5. **Логирование**
   - Все операции записываются в лог
   - Логи сохраняются в файл
   - В режиме эмуляции логируется мок-ответ

## Тестирование

### Режим эмуляции
1. Включите CheckBoxEmulationKKT
2. Программа будет возвращать успешный результат без реального подключения к ККТ

### Ручное тестирование
1. Создайте receipt_request.json с тестовым JSON
2. Создайте файл команды print_receipt.cmd
3. Проверьте появление receipt_response.json
4. Проверьте логи

## Требования

- Delphi программа должна быть запущена
- Таймер TimerForCommandsFrom1c включен
- Папка c:\share\checkmarks\ существует
- Драйвер АТОЛ установлен
- Права на запись в папку

## Преимущества

✅ Простая интеграция с 1С  
✅ Независимость от COM-объектов  
✅ Полное логирование  
✅ Обработка ошибок  
✅ Режим эмуляции для тестирования  
✅ Автоматическое управление соединением  

## Возможные проблемы

| Проблема | Причина | Решение |
|----------|---------|---------|
| Таймаут | Программа не запущена | Запустите программу |
| Ошибка чтения файла | Нет прав доступа | Проверьте права на папку |
| Ошибка ККТ | ККТ не подключена | Проверьте подключение или используйте эмуляцию |

## Дальнейшее развитие

Возможные улучшения:
- Очередь команд
- Приоритеты команд
- Асинхронное выполнение
- Отмена команд
- Повтор при ошибке

