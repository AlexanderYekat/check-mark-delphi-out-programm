═══════════════════════════════════════════════════════════
  СИСТЕМА КОМАНД ОТ 1С ЧЕРЕЗ ФАЙЛЫ
═══════════════════════════════════════════════════════════

📁 ПАПКА КОМАНД:
----------------
c:\share\checkmarks\commands\

Delphi программа постоянно мониторит эту папку через таймер.


📋 ДОСТУПНЫЕ КОМАНДЫ:
----------------------

Файл: process.txt (или process.cmd, process.*)
  → Команда: НАЧАТЬ ОБРАБОТКУ ЧЕКА
  → Действие: Загружает марки из CSV
  → Обработчик: ButtonReceiptProcessClick()

Файл: closing.txt
  → Команда: ЧЕК ЗАКРЫВАЕТСЯ
  → Действие: Сохраняет результаты, готовится к закрытию
  → Обработчик: ButtonReceiptClosingClick()

Файл: closed.txt
  → Команда: ЧЕК ЗАКРЫТ
  → Действие: Полная очистка данных
  → Обработчик: ButtonRecieptWasClosedClick()

Файл: cancel.txt
  → Команда: ОТМЕНИТЬ ЧЕК
  → Действие: Отменяет проверку, очищает данные
  → Обработчик: ButtonCancelReciptClick()


⚙️ КАК ЭТО РАБОТАЕТ:
---------------------

1️⃣ ТАЙМЕР (TimerForCommandsFrom1c):
   • Проверяет папку каждые N секунд (настраивается в свойствах)
   • Ищет все файлы в папке commands\
   • Читает имя файла (без расширения)
   • Определяет команду по имени

2️⃣ ОБРАБОТКА КОМАНДЫ:
   • Логирует: "Получена команда от 1С: <имя>"
   • Выполняет соответствующий обработчик
   • УДАЛЯЕТ файл команды сразу после получения

3️⃣ ЗАЩИТА:
   • Неизвестные команды логируются как предупреждение
   • Ошибки обработки не останавливают таймер


💻 КОД 1С ДЛЯ ОТПРАВКИ КОМАНД:
-------------------------------

Функция ОтправитьКоманду(ИмяКоманды) Экспорт
    
    ПутьКПапке = "c:\share\checkmarks\commands\";
    
    Попытка
        // Создаем папку, если её нет
        Файл = Новый Файл(ПутьКПапке);
        Если Не Файл.Существует() Тогда
            СоздатьКаталог(ПутьКПапке);
        КонецЕсли;
        
        // Создаем файл команды (содержимое не важно)
        ПутьКФайлу = ПутьКПапке + ИмяКоманды + ".txt";
        ЗаписьТекста = Новый ЗаписьТекста(ПутьКФайлу, КодировкаТекста.UTF8);
        ЗаписьТекста.ЗаписатьСтроку("command");
        ЗаписьТекста.Закрыть();
        
        Сообщить("✓ Команда отправлена: " + ИмяКоманды);
        Возврат Истина;
        
    Исключение
        Сообщить("✗ Ошибка отправки команды: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции


📝 ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ В 1С:
-------------------------------

// Начать обработку чека
ОтправитьКоманду("process");

// Чек закрывается (срочно завершить)
ОтправитьКоманду("closing");

// Чек закрыт (очистить данные)
ОтправитьКоманду("closed");

// Отменить чек
ОтправитьКоманду("cancel");


🔄 ЖИЗНЕННЫЙ ЦИКЛ ЧЕКА:
------------------------

1С: ОтправитьКоманду("process")
  ↓
Delphi: Таймер обнаруживает файл "process.txt"
  ↓
Delphi: Загружает марки из CSV
  ↓
Delphi: Удаляет файл "process.txt"
  ↓
... обработка марок ...
  ↓
1С: ОтправитьКоманду("closing")
  ↓
Delphi: Сохраняет результаты в CSV
  ↓
1С: Читает результаты
  ↓
1С: ОтправитьКоманду("closed")
  ↓
Delphi: Очищает все данные


📊 ЧТО ДЕЛАЕТ КАЖДАЯ КОМАНДА:
------------------------------

PROCESS:
  ✓ FClosingRecipt := False
  ✓ Загружает марки из input_marks.csv
  ✓ Инициализирует MemoResult с заголовком
  ✓ Готов к проверке марок

CLOSING:
  ✓ FClosingRecipt := True
  ✓ Сохраняет результаты → output_results.csv
  ✓ Прекращает принимать новые марки

CLOSED:
  ✓ ClearAllData() - очистка памяти
  ✓ Очистка всех полей формы
  ✓ FClosingRecipt := False
  ✓ Готов к новому чеку

CANCEL:
  ✓ cancelMarkingCodeValidation() - отменяет проверку на ККТ
  ✓ clearMarkingCodeValidationResult()
  ✓ Вызывает CLOSED (полная очистка)


🔍 ОТЛАДКА:
------------

Логи покажут:
[14:10:15] Получена команда от 1С: process
[14:10:15] → Команда: НАЧАТЬ ОБРАБОТКУ ЧЕКА
[14:10:15] ✓ Файл команды удален: process.txt
[14:10:15] Готов к обработке марок

[14:15:30] Получена команда от 1С: closing
[14:15:30] → Команда: ЧЕК ЗАКРЫВАЕТСЯ
[14:15:30] ✓ Файл команды удален: closing.txt
[14:15:30] === СОХРАНЕНИЕ РЕЗУЛЬТАТОВ ===


⚠️ ВАЖНО:
----------

• Таймер должен быть ВКЛЮЧЕН (Enabled = True)
• Интервал рекомендуется: 500-1000 мс
• Файлы удаляются СРАЗУ после обнаружения
• Содержимое файлов НЕ важно, важно только имя!


🛡️ ЗАЩИТА:
------------

✅ Если папка не существует → создается автоматически
✅ Неизвестные команды → логируются как предупреждение
✅ Ошибки удаления файла → логируются, не останавливают работу
✅ Ошибки обработки → логируются, таймер продолжает работу


📂 СТРУКТУРА ФАЙЛОВ КОМАНД:
----------------------------

c:\share\checkmarks\commands\
  ├── process.txt    ← создает 1С
  ├── closing.txt    ← создает 1С
  ├── closed.txt     ← создает 1С
  └── cancel.txt     ← создает 1С

После обработки: папка пустая (все удалено)


═══════════════════════════════════════════════════════════
  Асинхронная командная система
  Версия: 2.0 | Дата: 2025-01-10
═══════════════════════════════════════════════════════════

