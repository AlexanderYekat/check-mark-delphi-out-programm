# Эмуляция: Мок-ответы для печати чека

## Обзор

Добавлена функция `GetMockReceiptResponse()` для формирования реалистичных мок-ответов в режиме эмуляции ККТ.

## Функция

```pascal
function TCheckMarksForm.GetMockReceiptResponse(const RequestJSON: string): string;
```

## Поддерживаемые типы операций

### 1. Продажа / Возврат (sell / sellReturn)

**Определяется по наличию в JSON:** `sell` или `sellReturn`

**Возвращает:**
```json
{
  "fiscalParams": {
    "fiscalDocumentDateTime": "2024-10-16T14:30:00+03:00",
    "fiscalDocumentNumber": 123,
    "fiscalDocumentSign": "1494325660",
    "fiscalReceiptNumber": 1,
    "fnNumber": "9999078900000961",
    "registrationNumber": "0000000001002292",
    "shiftNumber": 12,
    "total": 72.34,
    "fnsUrl": "www.nalog.gov.ru"
  },
  "warnings": ""
}
```

### 2. Открытие смены (openShift)

**Определяется по наличию в JSON:** `openShift`

**Возвращает:**
```json
{
  "fiscalParams": {
    "fiscalDocumentDateTime": "2024-10-16T14:30:00+03:00",
    "fiscalDocumentNumber": 1,
    "fiscalDocumentSign": "1234567890",
    "fnNumber": "9999078900000961",
    "registrationNumber": "0000000001002292",
    "shiftNumber": 12
  },
  "warnings": ""
}
```

### 3. Закрытие смены (closeShift)

**Определяется по наличию в JSON:** `closeShift`

**Возвращает:**
```json
{
  "fiscalParams": {
    "fiscalDocumentDateTime": "2024-10-16T14:30:00+03:00",
    "fiscalDocumentNumber": 456,
    "fiscalDocumentSign": "2345678901",
    "fnNumber": "9999078900000961",
    "registrationNumber": "0000000001002292",
    "shiftNumber": 12
  },
  "warnings": ""
}
```

### 4. Прочие операции

**Для всех остальных операций:**

**Возвращает:**
```json
{
  "result": "OK",
  "emulation": true
}
```

## Параметры в мок-ответах

| Параметр | Описание | Значение |
|----------|----------|----------|
| `fiscalDocumentDateTime` | Дата/время документа | Текущее время в формате ISO 8601 |
| `fiscalDocumentNumber` | Номер фискального документа | 123 (sell), 1 (open), 456 (close) |
| `fiscalDocumentSign` | Признак фискального документа | Фиксированная строка |
| `fiscalReceiptNumber` | Номер чека за смену | 1 (только для sell) |
| `fnNumber` | Номер фискального накопителя | "9999078900000961" |
| `registrationNumber` | Регистрационный номер ККТ | "0000000001002292" |
| `shiftNumber` | Номер смены | 12 |
| `total` | Сумма чека | 72.34 (только для sell) |
| `fnsUrl` | URL ФНС для проверки | "www.nalog.gov.ru" (только для sell) |
| `warnings` | Предупреждения | Пустая строка |

## Использование

Функция автоматически вызывается в `ExecuteReceiptJSON()` когда включен режим эмуляции:

```pascal
if CheckBoxEmulationKKT.Checked then
begin
  ResponseJSON := GetMockReceiptResponse(RequestJSON);
  ErrorCode := 0;
  ErrorDescription := 'OK (эмуляция)';
end
```

## Логирование

В режиме эмуляции в лог записывается:
- Факт выполнения в режиме эмуляции
- Сформированный мок-ответ

Пример:
```
[14:30:00] Эмуляция: команда выполнена успешно
[14:30:00] Мок-ответ: {"fiscalParams":{"fiscalDocumentDateTime":"2024-10-16T14:30:00+03:00",...}}
```

## Преимущества

✅ **Реалистичные данные** - 1С получает ответ, идентичный реальному  
✅ **Тестирование без ККТ** - можно разрабатывать и тестировать без оборудования  
✅ **Актуальное время** - дата/время в ответе всегда текущие  
✅ **Различные операции** - поддержка продажи, возврата, открытия/закрытия смены  
✅ **Простое расширение** - легко добавить новые типы операций  

## Расширение

Для добавления нового типа операции:

1. Добавьте проверку в функцию:
```pascal
else if Pos('newOperation', LowerCase(RequestJSON)) > 0 then
begin
  // Формируем мок-ответ для новой операции
end
```

2. Заполните необходимые поля fiscalParams

3. Документируйте новый тип операции

## Совместимость

Мок-ответы полностью совместимы с форматом ответов реального драйвера АТОЛ и могут использоваться в 1С без изменений кода обработки.

